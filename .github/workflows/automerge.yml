name: Auto Approve and Merge PRs

on:
  pull_request:
  workflow_call:
    inputs:
      allowed-user:
        type: string
        default: 'dependabot[bot]'
    secrets:
      token:
        required: false

permissions:
  contents: write
  pull-requests: write
  checks: read
  actions: read

env:
  PR_URL: ${{ github.event.pull_request.html_url }}

jobs:
  auto-approve-and-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == (inputs.allowed-user || 'dependabot[bot]')
    steps:
      - name: Wait for PR checks to complete
        run: |
          sha=$(gh pr view "$PR_URL" --json headRefOid -q .headRefOid)
          while true; do
            checks=$(gh api "repos/{owner}/{repo}/commits/$sha/check-runs" --paginate -q \
              '[.check_runs[] | {name: .name, status: .status, conclusion: .conclusion}]')
            filtered=$(echo "$checks" | jq '[.[] | select(.name != "auto-approve-and-merge")]')
            if [ "$(echo "$filtered" | jq length)" -eq 0 ]; then
              echo "Waiting for checks to appear..."
              sleep 10
              continue
            fi
            failed=$(echo "$filtered" | jq -r '.[] | select(.conclusion == "failure") | .name + ": failure"')
            if [ -n "$failed" ]; then
              echo "$failed"
              exit 1
            fi
            running=$(echo "$filtered" | jq -r '.[] | select(.status != "completed") | .name + ": " + .status')
            if [ -n "$running" ]; then
              echo "$running"
              sleep 10
            else
              passed=$(echo "$filtered" | jq -r '.[] | .name + ": " + .conclusion')
              echo "$passed"
              break
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.token || github.token }}
      - name: Enable auto-approve
        run: gh pr review --approve "$PR_URL"
        env:
          GH_TOKEN: ${{ secrets.token || github.token }}
      - name: Enable auto-merge
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          GH_TOKEN: ${{ secrets.token || github.token }}
