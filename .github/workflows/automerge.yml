name: Auto Approve and Merge PRs

on:
  pull_request:
  workflow_call:
    inputs:
      allowed-user:
        type: string
        default: 'dependabot[bot]'
    secrets:
      token:
        required: false

permissions:
  contents: write
  pull-requests: write
  checks: read
  actions: read

env:
  PR_URL: ${{ github.event.pull_request.html_url }}

jobs:
  auto-approve-and-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == (inputs.allowed-user || 'dependabot[bot]')
    steps:
      - name: Wait for PR checks to complete
        run: |
          while true; do
            if ! checks=$(gh pr checks --json workflow,name,state "$PR_URL"); then
              echo "Failed to fetch checks"
              exit 1
            fi
            filtered_checks=$(echo "$checks" | jq -r '.[] | select(.workflow != "Auto Approve and Merge PRs")')
            failed=$(echo "$filtered_checks" | jq -r 'select(.state == "FAILURE") | .name + ": " + .state')
            if [ -n "$failed" ]; then
              echo "$failed"
              exit 1
            fi
            running=$(echo "$filtered_checks" | jq -r 'select(.state != "SUCCESS" and .state != "SKIPPED") | .name + ": " + .state')
            if [ -n "$running" ]; then
              echo "$running"
              sleep 10
            else
              passed=$(echo "$filtered_checks" | jq -r '.name + ": " + .state')
              echo "$passed"
              break
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.token || github.token }}
      - name: Enable auto-approve
        run: gh pr review --approve "$PR_URL"
        env:
          GH_TOKEN: ${{ secrets.token || github.token }}
      - name: Enable auto-merge
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          GH_TOKEN: ${{ secrets.token || github.token }}
